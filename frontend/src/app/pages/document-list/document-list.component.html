<div class="mx-auto mt-8 px-3 sm:px-4 max-w-6xl">

  <!-- Başlık bandı -->
  <section class="soft-card comic-outline surface-2 p-6 md:p-8 mb-5">
    <h2 class="text-3xl md:text-4xl font-extrabold tracking-tight"
        style="background-image:linear-gradient(90deg,hsl(var(--p)),hsl(var(--s)),hsl(var(--a)));
               -webkit-background-clip:text;background-clip:text;color:transparent;">
      Belgeler
    </h2>
    <p class="mt-2 text-sm muted">CV, Sertifikalar, Referanslar ve Raporlar</p>
    <div class="mt-4 h-px w-full"
         style="background-image:linear-gradient(90deg,hsl(var(--a)/0),hsl(var(--a)/.35),hsl(var(--a)/0));">
    </div>
  </section>

  <!-- Loading -->
  <div *ngIf="loading" class="flex justify-center my-12">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <!-- İçerik -->
  <div *ngIf="!loading" class="space-y-10">

    <ng-container *ngFor="let c of categories">
      <!-- Kategori başlığı ve sayaç -->
      <div class="flex items-center gap-2 md:justify-start">
        <h3 class="text-lg md:text-xl font-semibold" style="color:hsl(var(--s));">
          {{ c.label }}
        </h3>
        <span class="text-orange-400 font-semibold ml-1">
          {{ docsBy(c.key).length }}
        </span>
      </div>

      <!-- Boş durum -->
      <div *ngIf="docsBy(c.key).length === 0" class="muted italic">
        Bu kategoride belge yok.
      </div>

      <!-- Yatay şerit -->
      <div *ngIf="docsBy(c.key).length > 0" class="relative">

        <!-- Sol/sağ oklar -->
        <button type="button"
                class="hidden md:flex items-center justify-center absolute left-1 top-1/2 -translate-y-1/2 z-30
                       h-9 w-9 rounded-full ring-1 ring-base-300 bg-base-100/80 hover:bg-base-100 shadow
                       transition"
                aria-label="Sola kaydır"
                (click)="scrollCategory(c.key, -380)">
          <i class="pi pi-chevron-left"></i>
        </button>

        <button type="button"
                class="hidden md:flex items-center justify-center absolute right-1 top-1/2 -translate-y-1/2 z-30
                       h-9 w-9 rounded-full ring-1 ring-base-300 bg-base-100/80 hover:bg-base-100 shadow
                       transition"
                aria-label="Sağa kaydır"
                (click)="scrollCategory(c.key, 380)">
          <i class="pi pi-chevron-right"></i>
        </button>

        <!-- TRACK (drag-to-scroll + arrows) -->
        <div #track
             [attr.data-cat]="c.key"
             class="surface-1 rounded-xl overflow-x-auto scroll-smooth border border-base-300 shadow-sm
                select-none touch-pan-y snap-x snap-mandatory
                flex flex-nowrap gap-2 md:gap-3 p-2 md:p-3"
             [class.cursor-grab]="!dragging"
             [class.cursor-grabbing]="dragging"
             [class.snap-none]="dragging"
             (pointerdown)="dragStart($event, track)"
             (pointermove)="dragMove($event, track)"
             (pointerup)="dragEnd(track)"
             (pointercancel)="dragEnd(track)"
             (mouseleave)="dragEnd(track)"
             (click)="dragging ? $event.preventDefault() : null">

          <div *ngFor="let doc of docsBy(c.key)"
               class="carousel-item snap-start shrink-0 w-[11rem] sm:w-[12rem] md:w-[12.5rem] lg:w-[13rem]">

            <!-- Kart -->
            <article class="soft-card comic-outline relative overflow-hidden group">

              <!-- renkli overlay (pasif) -->
              <div aria-hidden="true"
                   class="absolute inset-0 pointer-events-none opacity-60
                          bg-gradient-to-br from-primary/15 via-secondary/12 to-accent/12">
              </div>

              <!-- İçerik -->
              <div class="relative z-10">
                <!-- Önizleme -->
                <div class="relative h-32 sm:h-36 md:h-40 rounded-t-lg overflow-hidden bg-base-100/70"
                     (mouseenter)="preloadPreview(doc)">
                  <ng-container *ngIf="previewCache.get(doc.id) as p; else placeholder">
                    <iframe *ngIf="isPdfType(p.type) && !isImageName(doc.fileName)"
                            [src]="p.safeRes"
                            class="absolute inset-0 w-full h-full bg-base-100/80"
                            title="Önizleme" loading="lazy" draggable="false"></iframe>

                    <img *ngIf="!isPdfType(p.type) && isImageName(doc.fileName)"
                         [src]="p.safeUrl" [alt]="doc.fileName"
                         class="absolute inset-0 w-full h-full object-contain bg-base-100/80"
                         draggable="false" />
                  </ng-container>

                  <ng-template #placeholder>
                    <div class="absolute inset-0 flex items-center justify-center">
                      <div class="flex flex-col items-center gap-1">
                        <div class="text-2xl">{{ fileIcon(doc.fileName) }}</div>
                        <div class="skeleton h-2 w-14 rounded"></div>
                      </div>
                    </div>
                  </ng-template>

                  <!-- hover parıltı -->
                  <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition
                              bg-[radial-gradient(ellipse_at_top,rgba(79,70,229,.20),transparent_60%)]"></div>

                  <div *ngIf="previewLoading.has(doc.id)"
                       class="absolute right-2 top-2 badge badge-outline bg-base-100/80 text-[10px]">
                    yükleniyor…
                  </div>
                </div>

                <!-- Gövde -->
                <div class="card-body p-2">
                  <h3 class="card-title text-[12px] font-semibold leading-tight line-clamp-2"
                      title="{{ doc.fileName }}">
                    {{ doc.fileName }}
                  </h3>

                  <div class="mt-1 flex items-center gap-1 text-[10px] muted">
                    <span class="px-1.5 py-0.5 rounded border border-base-300/60 bg-base-100/60">
                      {{ ext(doc.fileName) || (doc.contentType || 'dosya') }}
                    </span>
                    <span *ngIf="doc.size != null"
                          class="px-1.5 py-0.5 rounded border border-base-300/60 bg-base-100/60">
                      {{ formatSize(doc.size) }}
                    </span>
                  </div>

                  <!-- Aksiyonlar (balon stil) -->
                  <div class="card-actions relative z-20 pointer-events-auto justify-between pt-2">
                    <!-- Görüntüle -->
                    <a [routerLink]="['/documents', doc.id]"
                       (click)="$event.stopPropagation()"
                       class="inline-flex items-center gap-1.5 h-7 px-2.5 rounded-full text-[11px]
                              ring-1 ring-base-300 bg-base-100/80 hover:bg-base-100
                              transition shadow-sm">
                      <i class="pi pi-eye text-[12px]" style="color:hsl(var(--a));"></i>
                      <span class="font-medium" style="color:hsl(var(--bc));">Görüntüle</span>
                    </a>

                    <!-- İndir -->
                    <a [href]="downloadUrl(doc.id)" download
                       (click)="$event.stopPropagation()"
                       class="inline-flex items-center gap-1.5 h-7 px-2.5 rounded-full text-[11px]
                              border-0 shadow-inner btn-primary-solid"
                       style="background-image:linear-gradient(90deg,hsl(var(--p)),hsl(var(--s)));
                              color:hsl(var(--pc));">
                      <i class="pi pi-download text-[12px]"></i>
                      <span class="font-medium leading-none">İndir</span>
                    </a>

                    <!-- Sil (admin) -->
                    <button *ngIf="auth.isAdmin()" (click)="$event.stopPropagation(); delete(doc)"
                            class="inline-flex items-center gap-1.5 h-7 px-2.5 rounded-full text-[11px]
                                   ring-1 ring-error/40 bg-error/10 hover:bg-error/15 text-error
                                   transition">
                      <i class="pi pi-trash text-[12px]"></i>
                      <span class="font-medium leading-none">Sil</span>
                    </button>
                  </div>
                </div>
              </div>
            </article>
          </div>

        </div>
        <!-- /TRACK -->
      </div>
    </ng-container>

  </div>
</div>